

# User Flow: Мультимодальный ИИ-ассистент ОТК

> **Техническая архитектура**: Подробное описание технической реализации и архитектуры системы см. в @vision.md.
> **Рекомендации по реализации**: Детальные рекомендации по архитектуре LLM-взаимодействия см. в @scenario1.md.

### **Ключевые пользовательские роли (Personas):**
*   **Инспектор ОТК:** Основной пользователь, который проводит проверки и вносит данные.

### **Основные ветки сценария (Main Flows):**

---

### **Flow 1: Основной процесс внесения данных о проверке**

**Триггер:** Пользователь в любом состоянии (кроме обработки) отправляет боту текст, голосовое сообщение или фото/файл.

1.  **Начало (Исходное состояние)**
    *   **Состояние бота:** `idle`
    *   **Действие системы:** Бот готов к приему данных. Показывает интерфейс исх. состояния.
    *   **Действие пользователя:** Отправляет данные (текст, голос, фото).
    *   **Переход:** -> **`processing`**

2.  **Обработка данных (Критический путь)**
    *   **Состояние бота:** `processing`
    *   **Действие системы:** Бот показывает сообщение "Идёт обработка..." и интерфейс состояния обработки.    
    *   **Действие пользователя:**
        *   **a) Дожидается завершения обработки** 
            *   **Переход:** -> **`Возможные исходы`**
        *   **b) Нажимает "СТОП / ОТМЕНА"**
            *   **Переход:** -> **`cancellation`**
    *   **Возможные исходы:**
        *   **(Успех)** Система распознала данные и сформировала черновик протокола.
            *   **Переход:** -> **`confirmation`**
        *   **(Необходимо уточнение)** Системе не хватило данных или они противоречивы.
            *   **Переход:** -> **`clarification`**

3.  **Уточнение данных (Альтернативный путь)**
    *   **Состояние бота:** `clarification`
    *   **Действие системы:** Бот задает конкретный уточняющий вопрос (напр.: "Укажите, пожалуйста, серийный номер аппарата").
    *   **Действие пользователя:**
        *   **a) Отправляет уточняющие данные** (текст, голос, фото).
            *   **Переход:** -> **`processing`** (возврат на шаг 2 для дообработки)
        *   **b) Нажимает "СТОП / ОТМЕНА"**
            *   **Переход:** -> **`cancellation`**

4.  **Валидация итогов (Критический путь)**
    *   **Состояние бота:** `confirmation`
    *   **Действие системы:** Бот выводит итоговый свод данных для проверки и просит подтвердить ("Всё верно?").
    *   **Действие пользователя:**
        *   **a) Нажимает "ПОДТВЕРЖДАЮ"**
            *   **Действие системы:** Данные сохраняются в БД. Бот отправляет подтверждение ("Данные записаны! ID протокола: #123").
            *   **Переход:** -> **`idle`** (возврат в исходное состояние)
        *   **b) Нажимает "ИСПРАВИТЬ"**
            *   **Действие системы:** Бот предлагает ввести данные заново.
            *   **Переход:** -> **`idle`**
        *   **c) Нажимает "СТОП / ОТМЕНА"**
            *   **Переход:** -> **`cancellation`**

---

### **Flow 2: Запрос отчетов**

**Триггер:** Пользователь в исходном состоянии (`idle`) нажимает кнопку **"ОТЧЕТЫ"**.

1.  **Начало запроса**
    *   **Состояние бота:** `idle`
    *   **Действие пользователя:** Нажимает "ОТЧЕТЫ".
    *   **Переход:** -> **`reports_menu`**

2.  **Меню отчетов**
    *   **Состояние бота:** `reports_menu`
    *   **Действие системы:** Бот показывает меню с кнопками выбора типа отчета.
    *   **Действие пользователя:** Выбирает тип отчета (напр., "Сводка за сегодня").
    *   **Переход:** -> **`report_processing`**

3.  **Формирование отчета**
    *   **Состояние бота:** `report_processing`
    *   **Действие системы:** Бот показывает "Формирую отчет...", делает запрос к БД.
    *   **Действие системы:** Бот отправляет пользователю готовый отчет (файлом или текстовым сообщением).
    *   **Переход:** -> **`reports_menu`** (пользователь остается в меню для запроса нового отчета)

    *   **Альтернативное действие пользователя:** Нажимает "Выход".
        *   **Переход:** -> **`idle`**

---

### **Flow 3: Отмена действия (Global Exit)**

**Триггер:** Пользователь в состояниях `processing`, `clarification` или `confirmation` нажимает кнопку **"СТОП / ОТМЕНА"**.

1.  **Запрос на подтверждение отмены**
    *   **Состояние бота:** `cancellation`
    *   **Действие системы:** Бот показывает сообщение: "Вы уверены? Все несохраненные данные будут утеряны."
    *   **Действие пользователя:**
        *   **a) Нажимает "ПОДТВЕРЖДАЮ ОТМЕНУ"**
            *   **Действие системы:** Бот отменяет текущий сеанс, удаляет черновик.
            *   **Переход:** -> **`idle`**
        *   **b) Отправляет любое другое сообщение/не нажимает кнопку**
            *   **Действие системы:** Бот возвращает пользователя в предыдущее состояние, откуда была начата отмена (например, в `confirmation`).

---


# State Diagram (Диаграмма состояний) для ИИ-ассистента ОТК

| Состояние (State) | Сообщение / Контент от бота (UI) | Доступные действия пользователя (UI Elements) | Обработка ввода / Переход в состояние |
| :--- | :--- | :--- | :--- |
| **`idle`** | **Текст:** "Отправьте данные проверки: текст, голосовое сообщение или фото."<br>**Клавиатура:** `[ОТЧЕТЫ]` | 1. **Отправка файла/голоса/текста**<br>2. **Нажатие кнопки "ОТЧЕТЫ"** | 1. -> `processing` (с контекстом введенных данных)<br>2. -> `reports_menu` |
| **`processing`** | **Текст:** "Идёт обработка..."<br>**Клавиатура:** `[СТОП / ОТМЕНА]` | 1. **Нажатие кнопки "СТОП / ОТМЕНА"** | 1. -> `cancellation` (с контекстом текущей задачи) |
| **`clarification`** | **Текст:** "[Вопрос на уточнение, сгенерированный ИИ]. *Пример: 'Вы указали номер детали 155, но в системе зарегистрирована 155-А. Уточните, пожалуйста.'*"<br>**Клавиатура:** `[СТОП / ОТМЕНА]` | 1. **Отправка файла/голоса/текста** (уточняющие данные)<br>2. **Нажатие кнопки "СТОП / ОТМЕНА"** | 1. -> `processing` (передаются уточненные данные для повторного анализа)<br>2. -> `cancellation` |
| **`confirmation`** | **Текст:** "Проверьте данные перед записью:<br>• *Пункт 1: Значение*<br>• *Пункт 2: Значение*<br><br>Всё верно?"<br>**Клавиатура:** `[ПОДТВЕРЖДАЮ]` `[ИСПРАВИТЬ]` `[СТОП / ОТМЕНА]` | 1. **Нажатие кнопки "ПОДТВЕРЖДАЮ"**<br>2. **Нажатие кнопки "ИСПРАВИТЬ"**<br>3. **Нажатие кнопки "СТОП / ОТМЕНА"** | 1. -> **Данные пишутся в БД** -> `idle` (с сообщением об успехе)<br>2. -> `idle` (с предложением начать ввод заново)<br>3. -> `cancellation` |
| **`cancellation`** | **Текст:** "Вы уверены? Все несохраненные данные будут утеряны."<br>**Клавиатура:** `[ПОДТВЕРЖДАЮ ОТМЕНУ]` (и, возможно, `[ВЕРНУТЬСЯ]` для отмены диалога отмены) | 1. **Нажатие кнопки "ПОДТВЕРЖДАЮ ОТМЕНУ"**<br>2. **Любое другое сообщение** | 1. -> **Сброс текущего сеанса** -> `idle`<br>2. -> *Возврат в предыдущее состояние* (из которого была вызвана отмена) |
| **`reports_menu`** | **Текст:** "Выберите тип отчета:"<br>**Клавиатура:** `[Сводка за сегодня]` `[Сводка за неделю]` `[Данные за сегодня]` `[Данные за неделю]` `[Выход]` | 1. **Нажатие на кнопку с выбранным отчетом**<br>2. **Нажатие кнопки "Выход"** | 1. -> `report_processing` (с контекстом выбранного отчета)<br>2. -> `idle` |
| **`report_processing`** | **Текст:** "Формирую отчет... Это займет несколько секунд."<br>**Клавиатура:** *Может отсутствовать или быть скопирована из предыдущего состояния.* | 1. **Ожидание пользователя** | 1. -> **Система формирует отчет, отправляет его файлом/сообщением** -> `reports_menu` (пользователь остается в меню выбора отчетов) |

---
**Пояснения и рекомендации по реализации:**

1.  **Глобальная команда:** Команда `/start` должна всегда быть доступна и сбрасывать состояние бота к `idle`.
2.  **Контекст:** Для состояний `processing`, `clarification` и `confirmation` критически важно передавать контекст (например, ID сессии, распознанный текст, сформированный черновик JSON) между переходами. Это должен предусмотреть backend.
3.  **Клавиатуры:** Во всех состояниях, кроме `idle` и `reports_menu`, рекомендуется использовать **Reply-клавиатуры** (которые появляются вместо обычной клавиатуры) для кнопок `СТОП / ОТМЕНА` и т.д. Это делает интерфейс более guided.
4.  **Визуал:** Для состояний `processing` и `report_processing` можно использовать анимацию "часиков" (▌▌▌▌▌▌▌▌) или статус "печатает..." (`sendChatAction`), чтобы показать пользователю, что бот жив и работает.

Эта таблица является прямым руководством к действию для разработчика и идеально дополняет текстовый User Flow.