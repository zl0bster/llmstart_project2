# Система отчетов OTK Assistant

## Обзор

OTK Assistant предоставляет комплексную систему отчетов для анализа результатов проверок качества. Система поддерживает различные форматы отчетов и периоды анализа.

## Типы отчетов

### 1. Сводные отчеты (текстовые)

#### 📊 Сводка за день
- **Назначение**: Краткая статистика проверок за текущий день
- **Формат**: Текстовое сообщение в Telegram
- **Содержимое**:
  - Общее количество проверок
  - Количество уникальных заказов
  - Статистика по статусам (годно/в доработку/в брак)
  - Процент успешности
  - Статистика по контролерам (для общих отчетов)

#### 📈 Сводка за неделю
- **Назначение**: Краткая статистика проверок за текущую неделю (с понедельника)
- **Формат**: Текстовое сообщение в Telegram
- **Содержимое**: Аналогично дневной сводке, но за неделю

### 2. Детальные отчеты (CSV файлы)

#### 📄 CSV за день
- **Назначение**: Детальные данные всех проверок за день
- **Формат**: CSV файл для скачивания
- **Столбцы**:
  - Дата создания
  - Номер заказа
  - Статус
  - Комментарий
  - Контролер
  - ID сессии (сокращенный)

#### 📋 CSV за неделю
- **Назначение**: Детальные данные всех проверок за неделю
- **Формат**: CSV файл для скачивания
- **Содержимое**: Аналогично дневному CSV, но за неделю

## Команды и интерфейс

### Команды бота

- `/reports` - Открыть меню отчетов
- Кнопка "📊 ОТЧЕТЫ" в основном меню

### Меню отчетов

После выполнения команды `/reports` появляется интерактивное меню с кнопками:

```
┌─────────────────────────────────────┐
│ 📊 Сводка за сегодня │ 📈 Сводка за неделю │
├─────────────────────────────────────┤
│ 📋 Данные за сегодня │ 📄 Данные за неделю │
├─────────────────────────────────────┤
│           🚪 Выход                   │
└─────────────────────────────────────┘
```

## Права доступа

### Персональные отчеты
- **Кто видит**: Каждый пользователь видит только свои проверки
- **Содержимое**: Проверки, выполненные конкретным пользователем

### Общие отчеты
- **Кто видит**: Администраторы и менеджеры (функциональность будет добавлена в будущих версиях)
- **Содержимое**: Все проверки в системе с разбивкой по контролерам

## Временные периоды

### День
- **Период**: С 00:00 до 23:59 текущего дня
- **Часовой пояс**: Локальное время сервера

### Неделя
- **Период**: С понедельника 00:00 до воскресенья 23:59
- **Начало недели**: Понедельник
- **Часовой пояс**: Локальное время сервера

## Технические детали

### Архитектура

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Пользователь  │ -> │  Command        │ -> │  Report         │
│   /reports      │    │  Handlers       │    │  Service        │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                                │                       │
                       ┌─────────────────┐    ┌─────────────────┐
                       │   Keyboards     │    │   Database      │
                       │   (UI)          │    │   (Data)        │
                       └─────────────────┘    └─────────────────┘
```

### Файловая система

- **Временные файлы**: `{temp_dir}/otk_reports/`
- **Именование CSV файлов**:
  - Дневные: `otk_daily_report_{YYYY-MM-DD}.csv`
  - Недельные: `otk_weekly_report_{YYYY-WNN}.csv`
  - Персональные: `otk_{period}_report_user{id}_{date}.csv`

### Автоматическая очистка

- **Период хранения**: 1 день (настраивается)
- **Запуск**: При каждом создании нового отчета
- **Логирование**: Количество удаленных файлов записывается в лог

## Примеры использования

### Получение дневной сводки

1. Отправьте команду `/reports`
2. Нажмите "📊 Сводка за сегодня"
3. Получите текстовый отчет с основными показателями

### Экспорт данных за неделю

1. Отправьте команду `/reports`
2. Нажмите "📄 Данные за неделю"
3. Получите CSV файл для скачивания

### Примеры отчетов

#### Дневная сводка
```
📊 Сводка за день
📅 17.09.2025 - 18.09.2025

📈 Общая статистика:
🔍 Всего проверок: 15
📦 Уникальных заказов: 15
💬 С комментариями: 12

📊 Результаты проверок:
✅ Годно: 10 (66.7%)
🔧 В доработку: 4 (26.7%)
❌ В брак: 1 (6.7%)

🎯 Общая успешность: 66.7%

👥 По контролерам:
• Иванов И.И.: 8 проверок (75.0% успешных)
• Петров П.П.: 7 проверок (57.1% успешных)
```

#### CSV файл
```csv
Дата создания,Номер заказа,Статус,Комментарий,Контролер,ID сессии
2025-09-17 14:30:25,10001,годно,Все соответствует требованиям,Иванов И.И.,abc12345...
2025-09-17 14:45:12,10002,в доработку,Небольшие замечания,Петров П.П.,def67890...
```

## Обработка ошибок

### Нет данных за период
- **Сводки**: Показывается сообщение "За {период} проверок не проводилось"
- **CSV**: Файл не создается, показывается информационное сообщение

### Ошибки генерации
- **Логирование**: Все ошибки записываются в лог с деталями
- **Пользователю**: Показывается общее сообщение об ошибке
- **Восстановление**: Автоматический возврат в состояние idle

### Проблемы с файлами
- **Отсутствие файла**: Проверка существования перед отправкой
- **Ошибки отправки**: Повторная попытка или сообщение об ошибке
- **Дисковое пространство**: Автоматическая очистка старых файлов

## Настройки и конфигурация

### Переменные окружения

Все настройки берутся из основной конфигурации приложения (`app/core/config.py`).

### Логирование

- **Уровень**: INFO (создание отчетов), ERROR (ошибки)
- **Содержимое логов**:
  - Запросы отчетов от пользователей
  - Время генерации отчетов
  - Количество обработанных записей
  - Ошибки генерации
  - Статистика очистки файлов

## Производительность

### Рекомендации

- **Дневные отчеты**: Быстрые, обычно < 1 секунды
- **Недельные отчеты**: Могут занимать 2-5 секунд при большом объеме данных
- **CSV файлы**: Время генерации зависит от количества записей
- **Память**: CSV файлы создаются потоково, память не ограничивает размер

### Ограничения

- **Максимальный размер CSV**: Ограничен только доступным дисковым пространством
- **Concurrent requests**: Несколько пользователей могут запрашивать отчеты одновременно
- **Кэширование**: Отсутствует (каждый запрос генерирует новые данные)

## Будущие улучшения

### Планируемые функции (итерация 8+)

1. **Фильтрация по ролям**:
   - Администраторы видят все данные
   - Менеджеры видят данные своего отдела
   - Инспекторы видят только свои данные

2. **Дополнительные периоды**:
   - Месяц
   - Квартал
   - Произвольный период

3. **Расширенная аналитика**:
   - Тренды по времени
   - Сравнение с предыдущими периодами
   - Топ проблемных заказов

4. **Автоматические отчеты**:
   - Еженедельная рассылка
   - Уведомления о превышении лимитов брака
   - Напоминания о плановых проверках

5. **Экспорт в другие форматы**:
   - Excel (XLSX)
   - PDF отчеты
   - JSON для API

## Поддержка и устранение неисправностей

### Частые проблемы

1. **"Нет данных за период"**
   - Убедитесь, что в выбранный период были проведены проверки
   - Проверьте, что проверки были подтверждены и сохранены

2. **"Ошибка генерации отчета"**
   - Проверьте логи приложения
   - Убедитесь в доступности базы данных
   - Проверьте свободное место на диске

3. **CSV файл не отправляется**
   - Проверьте размер файла (ограничения Telegram)
   - Убедитесь в существовании файла
   - Проверьте права доступа к временной директории

### Логи для диагностики

```bash
# Логи генерации отчетов
grep "report_service" logs/app.log

# Ошибки отчетов
grep "ERROR.*report" logs/app.log

# Активность пользователей в отчетах
grep "reports" logs/app.log
```

### Восстановление после сбоев

1. **Очистка временных файлов**:
   ```python
   from app.services.report_service import report_service
   report_service.cleanup_old_files(days=0)  # Удалить все
   ```

2. **Пересоздание отчета**:
   - Повторный запрос через интерфейс бота
   - Автоматическое восстановление состояния пользователя
