# План разработки OTK Assistant

## Отчет о прогрессе

**Текущий статус**: Итерация 5 завершена успешно  
**Выполнено итераций**: 5/10  
**Последнее обновление**: 2025-09-16  

### История итераций
| № | Итерация | Статус | Результат | Дата |
|---|----------|--------|-----------|------|
| 1 | Базовый бот и конфигурация | ✅ Готово | Бот отвечает на /start и эхо-сообщения | 2025-09-13 |
| 2 | Текстовый пайплайн (MVP LLM) | ✅ Готово | Извлечение заказов/статусов из текста | 2025-09-14 |
| 3 | Хранение данных и сессии | ✅ Готово | БД, состояния системы, сессии с БД | 2025-09-15 |
| 4 | Голосовой пайплайн | ✅ Готово | Голос → транскрипция → анализ → сохранение | 2025-09-16 |
| 5 | Фото пайплайн (Vision) | ⏳ Планируется | Фото → извлечение → подтверждение → БД | - |
| 6 | Отчеты и экспорт | ⏳ Планируется | 4 типа отчетов (сводки + CSV) | - |
| 7 | Устойчивость и наблюдаемость | ⏳ Планируется | Retry, расширенное логирование | - |
| 8 | Переключаемые провайдеры | ⏳ Планируется | ENV-переключение моделей | - |
| 9 | Развертывание | ⏳ Планируется | Docker + Railway | - |
| 10 | Полировка и UX | ⏳ Планируется | End-to-end сценарии | - |

---

## Итерация 1: Базовый бот и конфигурация

**Цель**: Создать работающий Telegram бот с базовой конфигурацией  
**Критерий готовности**: Бот отвечает на /start и эхо-сообщения, логи пишутся, полная структура проекта создана  
**Ссылки**: @vision.md (строки 59-121, 554-683, 917-924), @conventions.md

### Задачи:
- [x] Создать полную структуру проекта согласно @vision.md (строки 59-121)
- [x] Создать все необходимые директории (app/, cache/, data/, logs/, prompts/, tests/, docker/)
- [x] Создать пустые __init__.py файлы в пакетах
- [x] Настроить requirements.txt с базовыми зависимостями
- [x] Создать .env.example с переменными окружения согласно @vision.md (строки 554-683)
- [x] Реализовать app/core/config.py (Pydantic BaseSettings) с полной схемой конфигурации
- [x] Создать app/main.py - точку входа aiogram приложения
- [x] Реализовать базовые обработчики (/start, эхо-сообщения)
- [x] Настроить базовое логирование (файлы + консоль)
- [x] Создать README.md с инструкциями по запуску
- [x] Протестировать: бот запускается и отвечает на команды

### Документация:
- [x] Обновить README.md с Quick Start
- [x] Создать .env.example с комментариями и всеми переменными из @vision.md

---

## Итерация 2: Текстовый пайплайн (MVP LLM)

**Цель**: Интегрировать LLM для анализа текстовых сообщений  
**Критерий готовности**: По тексту извлекаются заказы/статусы, есть подтверждение. **Тестирование**: Успешная обработка всех примеров из @scen1_use_cases.md  
**Ссылки**: @vision.md (строки 877-880), @scenario1.md, @scen1_use_cases.md

### Задачи:
- [x] Добавить зависимости для LLM (openai, pydantic, langchain)
- [x] Создать app/clients/llm_client.py - клиент для OpenRouter API
- [x] Создать app/models/schemas.py - Pydantic модели (OrderData, LLMResponse)
- [x] Создать prompts/system_prompts.py - системные промпты
- [x] Реализовать app/services/session_manager.py - управление сессиями
- [x] Обновить app/bot/handlers/text_handlers.py - обработка через LLM
- [x] Добавить app/bot/keyboards.py - кнопки подтверждения
- [x] Реализовать цикл подтверждения (Согласен/Исправить/Отменить)
- [x] Добавить логирование LLM запросов/ответов
- [x] Создать тестовые сценарии на основе @scen1_use_cases.md
- [x] Протестировать извлечение данных из примеров прямого текста
- [x] Протестировать извлечение данных из примеров аудио-транскрипции
- [x] Протестировать извлечение данных из примеров OCR текста
- [x] Протестировать: текст → извлечение данных → подтверждение

### Документация:
- [ ] Создать prompts/README.md - правила промптов согласно @vision.md (строки 902-913)
- [x] Обновить README.md с примерами использования

---

## Итерация 3: Хранение данных и сессии

**Цель**: Реализовать сохранение данных в SQLite с управлением сессиями и состояниями системы  
**Критерий готовности**: Подтвержденные проверки сохраняются, история сессии доступна, состояния системы работают  
**Ссылки**: @vision.md (строки 123-165, 261-296, 931-933), @scen1_user_flow.md

### Задачи:
- [x] Добавить SQLAlchemy в requirements.txt
- [x] Создать app/models/database.py - SQLAlchemy модели (User, Inspection, Dialogue)
- [x] Создать app/core/database.py - подключение к SQLite
- [x] Реализовать миграции БД (создание таблиц)
- [x] Обновить Session Manager для работы с БД
- [x] Создать app/services/data_service.py - бизнес-логика сохранения
- [x] Реализовать состояния системы согласно @vision.md (строки 123-165)
- [x] Создать State Machine для переходов между состояниями (idle, processing, clarification, confirmation, cancellation, reports_menu, report_processing)
- [x] Реализовать UI элементы для каждого состояния (клавиатуры, сообщения)
- [x] Добавить обработку переходов между состояниями
- [x] Реализовать сохранение только после подтверждения пользователя
- [x] Добавить логирование операций с БД
- [x] Создать команду /status для проверки данных
- [x] Протестировать: подтверждение → сохранение в БД → проверка
- [x] Протестировать переходы между состояниями согласно @scen1_user_flow.md

### Документация:
- [x] Обновить README.md с описанием БД
- [ ] Создать docs/API.md - описание команд бота согласно @vision.md (строки 902-913)

---

## Итерация 4: Голосовой пайплайн

**Цель**: Добавить обработку голосовых сообщений через Whisper  
**Критерий готовности**: Голос → текст → подтверждение → запись в БД. **Тестирование**: Транскрипция соответствует примерам из @scen1_use_cases.md  
**Ссылки**: @vision.md (строки 886-888), @scen1_use_cases.md

### Задачи:
- [x] Добавить зависимости для обработки аудио
- [x] Создать app/clients/speech_client.py - клиент для Whisper API
- [x] Создать app/services/media_processor.py - обработка медиа файлов
- [x] Реализовать app/bot/handlers/voice_handlers.py
- [x] Настроить сохранение аудио в cache/audio/
- [x] Интегрировать транскрипцию в текстовый пайплайн
- [x] Добавить валидацию аудио файлов (размер, длительность)
- [x] Реализовать логирование обработки голоса
- [x] Добавить обработку ошибок Whisper API
- [x] Создать тестовые сценарии для голосового пайплайна
- [x] Протестировать end-to-end пайплайн через симуляцию
- [x] Интегрировать voice_handlers в основное приложение
- [x] Протестировать: голос → транскрипция → анализ → сохранение

### Документация:
- [x] Обновить README.md с требованиями к аудио
- [ ] Обновить docs/API.md с голосовыми командами

---

## Итерация 5: Фото пайплайн (Vision)

**Цель**: Добавить анализ фотографий протоколов через Vision API  
**Критерий готовности**: Фото протокола → извлечение → подтверждение → запись в БД. **Тестирование**: OCR соответствует примерам из @scen1_use_cases.md  
**Ссылки**: @vision.md (строки 890-892), @scen1_use_cases.md

### Задачи:
- [x] Создать app/clients/vision_client.py - клиент для GPT-4 Vision
- [x] Реализовать app/bot/handlers/photo_handlers.py
- [x] Настроить сохранение фото в cache/photos/
- [x] Добавить валидацию изображений (размер, формат, разрешение)
- [x] Интегрировать анализ изображений в текстовый пайплайн
- [x] Реализовать логирование Vision API запросов
- [x] Добавить обработку ошибок Vision API
- [x] Создать специализированные промпты для анализа протоколов
- [x] Добавить поддержку альтернативных Vision моделей (OpenRouter + GPT-4 Vision)
- [x] Создать тестовый скрипт для проверки пайплайна
- [x] Протестировать создание Vision клиентов и доступность API
- [x] Протестировать сохранение и валидацию изображений
- [x] Протестировать интеграцию с основным приложением
- [x] Протестировать: фото → анализ → извлечение данных → обработка через LLM

### Документация:
- [x] Обновить README.md с требованиями к изображениям
- [ ] Обновить docs/API.md с фото-командами

---

## Итерация 6: Отчеты и экспорт

**Цель**: Реализовать генерацию отчетов для всех пользователей  
**Критерий готовности**: Любой пользователь получает сводку и CSV за выбранный период  
**Ссылки**: @vision.md (строки 894-896)

### Задачи:
- [ ] Создать app/services/report_service.py - генерация отчетов
- [ ] Реализовать 4 типа отчетов (сводки + CSV за день/неделю)
- [ ] Создать app/bot/handlers/command_handlers.py - команды отчетов
- [ ] Добавить генерацию CSV файлов
- [ ] Реализовать отправку файлов через Telegram
- [ ] Добавить логирование создания отчетов
- [ ] Создать команды /reports для меню отчетов
- [ ] Протестировать: запрос отчета → генерация → отправка

### Документация:
- [ ] Обновить docs/API.md с командами отчетов
- [ ] Создать docs/REPORTS.md - описание типов отчетов согласно @vision.md (строки 902-913)

---

## Итерация 7: Устойчивость и наблюдаемость

**Цель**: Добавить retry механизмы и расширенное логирование  
**Критерий готовности**: Искусственно вызванные сбои корректно обрабатываются, детальная система логирования работает  
**Ссылки**: @vision.md (строки 701-782, 947-949)

### Задачи:
- [ ] Реализовать retry механизм для API запросов
- [ ] Реализовать детальную систему логирования согласно @vision.md (строки 701-782)
- [ ] Настроить JSON формат логов с корреляцией запросов (request_id, session_id, llm_request_id)
- [ ] Реализовать ротацию логов с архивированием (ежедневная, хранение 7 дней)
- [ ] Добавить структурированное логирование LLM запросов/ответов (время, токены, размеры, длительности)
- [ ] Реализовать маскировку секретов в логах (api_key, Authorization)
- [ ] Создать отдельные лог-файлы: app.log, error.log, llm.log, user.log
- [ ] Реализовать fallback сообщения при сбоях
- [ ] Добавить метрики производительности
- [ ] Создать app/utils/helpers.py - утилиты для обработки ошибок
- [ ] Реализовать graceful shutdown приложения
- [ ] Добавить health check endpoint
- [ ] Создать мониторинг использования API
- [ ] Протестировать: сбои API → retry → fallback → логирование

### Документация:
- [ ] Создать docs/MONITORING.md - описание логирования согласно @vision.md (строки 701-782)
- [ ] Обновить README.md с информацией о мониторинге

---

## Итерация 8: Переключаемые провайдеры и модели

**Цель**: Добавить возможность переключения между разными LLM провайдерами  
**Критерий готовности**: Смена ENV приводит к использованию другой модели без правок кода  
**Ссылки**: @vision.md (строки 902-904)

### Задачи:
- [ ] Создать app/clients/providers/ - провайдеры (OpenRouter, Ollama, LM Studio)
- [ ] Реализовать app/clients/base_client.py - базовый интерфейс
- [ ] Добавить поддержку локальных моделей (Ollama, LM Studio)
- [ ] Обновить конфигурацию для переключения провайдеров
- [ ] Реализовать fallback между провайдерами
- [ ] Добавить валидацию доступности провайдеров
- [ ] Создать команду /config для проверки настроек
- [ ] Добавить логирование переключений провайдеров
- [ ] Реализовать кэширование моделей
- [ ] Протестировать: смена ENV → переключение модели → работа

### Документация:
- [ ] Обновить .env.example с примерами провайдеров
- [ ] Создать docs/PROVIDERS.md - описание провайдеров согласно @vision.md (строки 902-913)

---

## Итерация 9: Развертывание

**Цель**: Подготовить проект к развертыванию в Docker и Railway  
**Критерий готовности**: Запуск в Docker и (опционально) развертывание в Railway, все Makefile команды работают  
**Ссылки**: @vision.md (строки 822-837, 955-957)

### Задачи:
- [ ] Создать Dockerfile для контейнеризации
- [ ] Создать docker-compose.yml для локальной разработки
- [ ] Реализовать все 12 команд Makefile согласно @vision.md (строки 822-837)
- [ ] Создать команды: dev, build, run, stop, logs, clean, test, lint, format, install, db-migrate, db-reset, db-backup, db-export
- [ ] Подготовить docs/DEPLOYMENT.md - инструкции по развертыванию
- [ ] Настроить переменные окружения для продакшна согласно @vision.md
- [ ] Создать .dockerignore для оптимизации сборки
- [ ] Добавить health check в Docker
- [ ] Подготовить Railway конфигурацию
- [ ] Создать скрипты для бэкапа БД
- [ ] Протестировать: Docker build → run → Railway deploy
- [ ] Протестировать все Makefile команды

### Документация:
- [ ] Создать docs/DEPLOYMENT.md - полное руководство по развертыванию согласно @vision.md (строки 902-913)
- [ ] Обновить README.md с инструкциями по Docker

---

## Итерация 10: Полировка и UX

**Цель**: Улучшить пользовательский опыт и стабильность  
**Критерий готовности**: End-to-end сценарии (текст/голос/фото/отчеты) проходят стабильно  
**Ссылки**: @vision.md (строки 910-912), @scen1_use_cases.md

### Задачи:
- [ ] Улучшить клавиатуры и интерфейс бота
- [ ] Оптимизировать промпты для лучшего извлечения данных
- [ ] Добавить валидацию пользовательского ввода
- [ ] Реализовать роли пользователей с разными правами
- [ ] Добавить команду /help с описанием функций
- [ ] Оптимизировать производительность (кэширование, батчинг)
- [ ] Добавить обработку edge cases
- [ ] Улучшить сообщения об ошибках
- [ ] Создать интеграционные тесты
- [ ] Создать комплексные тесты на основе @scen1_use_cases.md
- [ ] Протестировать edge cases из реальных примеров
- [ ] Валидировать точность извлечения данных по всем типам ввода
- [ ] Создать тестовый набор для регрессионного тестирования
- [ ] Протестировать: полные пользовательские сценарии

### Документация:
- [ ] Создать docs/CHANGELOG.md - история изменений согласно @vision.md (строки 902-913)
- [ ] Создать docs/SETUP.md - детальная установка/обновление, заполняется по мере проработки итераций
- [ ] Обновить README.md с финальной документацией

---

## Принципы работы

### Обязательные правила:
- ✅ **Строгое следование плану** - одна итерация = один проверяемый результат
- ✅ **Согласование решения** перед реализацией
- ✅ **Обновление прогресса** после каждого этапа
- ✅ **Тестирование** перед переходом к следующей итерации
- ✅ **Следование принципам KISS** из @vision.md

### Критерии готовности итерации:
1. Все задачи итерации выполнены согласно @vision.md
2. Функциональность протестирована (включая тесты из @scen1_use_cases.md)
3. Код соответствует @conventions.md
4. Документация обновлена согласно @vision.md (строки 902-913)
5. Состояния системы работают согласно @scen1_user_flow.md (для итераций 3+)
6. Логирование работает согласно @vision.md (строки 701-782) (для итераций 7+)
7. Makefile команды работают согласно @vision.md (строки 822-837) (для итераций 9+)
8. Прогресс отмечен в этом файле
9. Сделан коммит с описанием изменений

### Ссылки на документы:
- @vision.md - техническое видение и архитектура
  - Строки 59-121: Структура проекта
  - Строки 123-165: Пользовательский интерфейс и состояния
  - Строки 261-296: Модель данных
  - Строки 554-683: Конфигурирование
  - Строки 701-782: Подход к логгированию
  - Строки 822-837: Makefile команды
  - Строки 902-913: Документация
  - Строки 917-961: План разработки
- @conventions.md - правила разработки кода
- @workflow.mdc - процесс работы над итерациями
- @scenario1.md - детальные сценарии использования
- @scen1_use_cases.md - реальные примеры для тестирования
- @scen1_user_flow.md - пользовательские потоки и состояния системы

---

## Тестовые сценарии

### Источники тестовых данных:
- **@scen1_use_cases.md** - реальные примеры текстов для тестирования LLM
- **Прямой текст** - оригинальные сообщения пользователей
- **Аудио-транскрипция** - результат Whisper API
- **OCR текст** - результат анализа изображений

### Критерии успешного тестирования:
1. **Извлечение номеров заказов** - корректное распознавание #с10409, #с10494, etc.
2. **Определение статусов** - "годно", "в доработку", "в брак"
3. **Обработка комментариев** - сохранение технических деталей
4. **Множественные заказы** - обработка нескольких заказов в одном сообщении
5. **Сложные случаи** - неполные данные, требующие уточнения
6. **Состояния системы** - корректные переходы между состояниями согласно @scen1_user_flow.md
7. **UI элементы** - правильные клавиатуры и сообщения для каждого состояния

### Тестовые примеры по итерациям:
- **Итерация 2**: Все примеры прямого текста
- **Итерация 3**: Тестирование состояний системы и переходов
- **Итерация 4**: Все примеры аудио-транскрипции  
- **Итерация 5**: Все примеры OCR текста
- **Итерация 7**: Тестирование логирования и обработки ошибок
- **Итерация 9**: Тестирование всех Makefile команд
- **Итерация 10**: Комплексное тестирование всех типов

### Дополнительные предложения:
- [ ] Создать тестовый скрипт для автоматической проверки всех примеров
- [ ] Добавить метрики точности для оценки качества извлечения данных
- [ ] Создать базу тестовых данных для регрессионного тестирования
- [ ] Добавить валидацию результатов против эталонных данных
