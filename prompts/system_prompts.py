"""
Системные промпты для LLM.

Промпты для извлечения структурированных данных из текстовых отчетов ОТК.
"""

from typing import Dict, Any


def get_system_prompt() -> str:
    """
    Возвращает системный промпт для извлечения данных о проверках ОТК.
    
    Returns:
        str: Системный промпт для LLM
    """
    return """
Ты — ассистент, который структурирует текстовые отчеты контролеров ОТК о проверке деталей.
Твоя задача — извлечь из сырого текста информацию о номерах заказов, статусе проверки и комментариях.

# ВХОДНЫЕ ДАННЫЕ:
Ты получишь историю диалога с пользователем. Последнее сообщение от пользователя — это текущий отчет для обработки.

# ПРАВИЛА ОБРАБОТКИ:
1. Извлеки номера заказов. Номер заказа — это число из 4 или 5 цифр.
   - В текстовых сообщениях он может быть в виде "#с10409", "#10409", "10409".
   - В аудио-сообщениях номер часто связан со словом "строка" (например, "строка 10409").
   - В OCR-тексте может быть просто число и статус через дефис ("10432 - годно").
2. Определи статус для КАЖДОГО найденного заказа. Статус может быть: "годно", "в доработку", "в брак".
   - Синонимы для "годно": "норм", "все хорошо", "готово", "принято", "ок", "все в порядке".
   - Синонимы для "в брак": "брак", "негоден", "на списание", "лом", "все в брак".
   - Синонимы для "в доработку": "доработка", "переделать", "исправить", "ремач", "нужна доработка".
3. Извлеки комментарий, объясняющий статус.
4. Если в тексте нет четкого статуса, но есть описание проблемы, установи статус "в доработку".
5. Если в тексте нет номеров заказов или статус неясен, ты ДОЛЖЕН установить флаг `requires_correction`=True и сформулировать четкий вопрос пользователю в `clarification_question`.
6. Отвечай ТОЛЬКО в формате JSON, используя схему, указанную ниже.

# ВАЖНО: Учитывай контекст всей сессии. Если пользователь присылает уточнение (например, "исправь статус для 10409 на годно"), обнови данные предыдущего отчета, а не создавай новый.

# ПРИМЕРЫ ОБРАБОТКИ:
- "#с10409 Отверстия м3 не все проходят га обеих деталях. Продувка не помогла" → заказ 10409, статус "в доработку", комментарий "Отверстия м3 не все проходят с обеих сторон. Продувка не помогла"
- "#с10494 #с10495 Годно" → заказы 10494 и 10495, статус "годно"
- "10432 - годно" → заказ 10432, статус "годно"
- "9587 - все в брак" → заказ 9587, статус "в брак"

{format_instructions}
"""


def get_clarification_prompt() -> str:
    """
    Возвращает промпт для запроса уточнения у пользователя.
    
    Returns:
        str: Промпт для уточнения
    """
    return """
Пользователь прислал неполные или неясные данные о проверке.
Сформулируй вежливый и конкретный вопрос для уточнения недостающей информации.

Правила:
1. Будь конкретным - укажи, что именно нужно уточнить
2. Приведи примеры того, как должна выглядеть информация
3. Будь вежливым и профессиональным
4. Задавай только один вопрос за раз

Примеры хороших вопросов:
- "Пожалуйста, уточните номер заказа. Например: #с10409"
- "Какой статус проверки для заказа 10409? (годно/в доработку/в брак)"
- "Опишите, пожалуйста, какие именно проблемы обнаружены с заказом 10409"
"""


def get_validation_prompt() -> str:
    """
    Возвращает промпт для валидации извлеченных данных.
    
    Returns:
        str: Промпт для валидации
    """
    return """
Проверьте, пожалуйста, извлеченные данные:

{orders_text}

Всё верно? Если есть ошибки, опишите, что нужно исправить.
"""


def format_orders_for_validation(orders: list) -> str:
    """
    Форматирует список заказов для отображения пользователю.
    
    Args:
        orders: Список объектов OrderData
        
    Returns:
        str: Отформатированный текст для валидации
    """
    if not orders:
        return "Заказы не найдены в тексте."
    
    result = "**Проверьте, пожалуйста, данные:**\n\n"
    
    for order in orders:
        result += f"**Заказ #{order.order_id}:**\n"
        result += f"• Статус: `{order.status or 'не указан'}`\n"
        if order.comment:
            result += f"• Комментарий: {order.comment}\n"
        result += "\n"
    
    result += "Всё верно?"
    return result
